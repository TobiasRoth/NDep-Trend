---
title: No sign of recovery 
preprint: false
author: 
  - name: Tobias Roth
    affiliation: 1, 2
    corresponding: true
    email: t.roth@unibas.ch
  - name: Lukas Kohli
    affiliation: 2
affiliation:
  - code: 1
    address: Zoological Institute, University of Basel, Basel, Switzerland
  - code: 2
    address: Hintermann  Weber AG, Austrasse 2a, 4153 Reinach, Switzerland
abstract: >
  Nitrogen (N) deposition is a major threat to biodiversity of many habitats. The recent intro- duction of cleaner technologies in Switzerland has let to reductions in the emissions of nitro- gen oxides, with affiliated decrease in N-deposition. We infered different drivers of community change (i.e. Nitrogen deposition, climate warming, land-use change) in Swiss mountain hay meadows. The data were obtained from the Swiss biodiversity monitoring.
  Species gain and losses were best explainde by differences in Ellenberg value for temperature suggesting that climate warming was the most important driver of community change in Mountain hay meadows. 
  
  
header-includes: >
  \usepackage{lipsum}
bibliography: Bibliography.bib
output: 
  rticles::peerj_article:
    base_format: bookdown::pdf_document2 
---

```{r settings, echo = FALSE, message=FALSE, cache=FALSE}
source("R/Settings.R")
```


# Introduction {-}
Nitrogen (N) deposition is a major threat to biodiversity. The recent introduction of cleaner technologies has let to reductions in the emissions of nitrogen oxides, with affiliated decrease in N-deposition in many parts of Europe. However, it is an open question whether and how fast the reduction in N deposition rates will lead to the recovey of extant plant communities.

One useful approach to understanding biodiversity change is through estimates of biodiversity turnover reflecting both immigration and extinction, often in a closed range of values (Hillebrand_et_al-2018.pdf).

Here we infered mountain hay meadows in Switzerland. Explain why mountain hay meadows are important. Also explain other threats to mountain hay meadows (climate change, land-use change). 
 


# Materials & Methods {-}

## Monitoring data {-}
- Selection of sample sites based on 1366 K_Standort.csv column "E23_1366".
- Three surveys 2003-2007, 2008-2012 and 2013 - 2017.

## Plant traits {-}
Functional traits:

- SLA: specific leaf area
- CH: canopy height
- SM: Seed mass

Ellenberg indicator values:

- L: light
- N: Nutrient contentent
- T: Temperature
- F: Huminity

Community measures:

- Species richness: number of recorded species per $10m^2$.
- Spatial turnover (beta-diversity): Average turnover between all pair-wise combinations of study plots.
- gamma diversity: Total number of species recorded in all study plots.

### Community measures {-}

The temporal turnover (i.e. species exchange ratio sensu @Hillebrand2018) is the proportion of species that differ between two time points calculated as

$\text{Spatial turnover} = \frac{\text{Species gained} + \text{Species lost}}{\text{Total species observed in both timepoints}}$.



## Statistical analyses {-}
Environmental variables were standardized.


```{r helpfunctions}
# Help functions to get posterior samples
getposterior <- function(x) {
  list( 
    `EL = 2` = plogis(simdat[x,1] + Xsd * simdat[x,2] - simdat[x,3] -  Xsd * simdat[x,4]),
    `EL = 4` = plogis(simdat[x,1] + Xsd * simdat[x,2] + simdat[x,3] +  Xsd * simdat[x,4]))
}

compileres <- function(EL) {
  tt <- map(1:length(X), function(s) map(post, paste(EL)) %>% map_dbl(s))
  tibble(mean = map_dbl(tt, mean),
         low = map_dbl(tt, quantile, probs = 0.025),
         high = map_dbl(tt, quantile, probs = 0.975),
         X = X,
         value = paste(EL)
  )
}
```

# Results {-}
```{r temporaltrends, results='asis', }
res <- tibble(Measures = c("Alpha-diversity", "Beta-diversity", "Gamma-Diversity", 
                           "Temperature value", "Huminity value", "Nutrients value", "Light value", 
                           "Canopy height", "Specific leaf area", "Seed mass"))
res$'Period 1' <- ""; res$'Period 2' <- ""; res$'Period 3' <- ""
res$'Temporal-Trend' <- ""; res$'P-value' <- ""

# Alpha diversity
res[1, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$SR, surv$Visit, mean), 2)
tmp <- summary(glmer(SR ~ yr + (yr|aID_STAO), data = surv, family = poisson))$coefficients
res[1, "Temporal-Trend"] <- formatC(tmp["yr", "Estimate"], format = "f", digits = 3)
res[1, "P-value"] <- formatC(tmp["yr", "Pr(>|z|)"], format = "f", digits = 3)

# Beta diversity
getbeta <- function(x) {
  tmp <- simba::sim(pl %>% filter(Visit == x) %>% dplyr::select(aID_STAO, aID_SP, Occ), method = "simpson", 
            listin = TRUE, listout = TRUE)
  formatC(tmp$simpson, format = "f", digits = 2)
}
res[2, c("Period 1", "Period 2", "Period 3")] <- lapply(1:3, getbeta)

# Gamma diversity
res[3, c("Period 1", "Period 2", "Period 3")] <- tapply(pl$aID_SP, pl$Visit, function(x) length(unique(x)))

# Mean community index
res[4, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$T, surv$Visit, mean), 2)
tmp <- summary(lme(T ~ yr, random = ~ yr|aID_STAO, data = surv))$tTable
res[4, "Temporal-Trend"] <- formatC(tmp["yr", "Value"], format = "f", digits = 3)
res[4, "P-value"] <- formatC(tmp["yr", "p-value"], format = "f", digits = 3)

res[5, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$F, surv$Visit, mean), 2)
tmp <- summary(lme(F ~ yr, random = ~ yr|aID_STAO, data = surv))$tTable
res[5, "Temporal-Trend"] <- formatC(tmp["yr", "Value"], format = "f", digits = 3)
res[5, "P-value"] <- formatC(tmp["yr", "p-value"], format = "f", digits = 3)

res[6, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$N, surv$Visit, mean), 2)
tmp <- summary(lme(N ~ yr, random = ~ yr|aID_STAO, data = surv))$tTable
res[6, "Temporal-Trend"] <- formatC(tmp["yr", "Value"], format = "f", digits = 3)
res[6, "P-value"] <- formatC(tmp["yr", "p-value"], format = "f", digits = 3)

res[7, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$L, surv$Visit, mean), 2)
tmp <- summary(lme(L ~ yr, random = ~ yr|aID_STAO, data = surv))$tTable
res[7, "Temporal-Trend"] <- formatC(tmp["yr", "Value"], format = "f", digits = 3)
res[7, "P-value"] <- formatC(tmp["yr", "p-value"], format = "f", digits = 3)

# Average of functional traits
res[ 8, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$CH, surv$Visit, mean), 2)
tmp <- summary(lmer(CH ~ yr + (yr|aID_STAO), data = surv))$coefficients
res[ 8, "Temporal-Trend"] <- formatC(tmp["yr", "Estimate"], format = "f", digits = 3)
tmp <- anova(lmer(CH ~ yr + (yr|aID_STAO), data = surv), lmer(CH ~ 1 + (yr|aID_STAO), data = surv))[2, "Pr(>Chisq)"]
res[ 8, "P-value"] <- formatC(tmp, format = "f", digits = 3)

res[9, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$SLA, surv$Visit, mean), 2)
tmp <- summary(lme(SLA ~ yr, random = ~ yr|aID_STAO, data = surv))$tTable
res[9, "Temporal-Trend"] <- formatC(tmp["yr", "Value"], format = "f", digits = 3)
res[9, "P-value"] <- formatC(tmp["yr", "p-value"], format = "f", digits = 3)

res[10, c("Period 1", "Period 2", "Period 3")] <- round(tapply(surv$SM, surv$Visit, mean), 2)
tmp <- summary(lme(SM ~ yr, random = ~ yr|aID_STAO, data = surv))$tTable
res[10, "Temporal-Trend"] <- formatC(tmp["yr", "Value"], format = "f", digits = 3)
res[10, "P-value"] <- formatC(tmp["yr", "p-value"], format = "f", digits = 3)
 
print(xtable(res, align = c("l", "l", rep("r", 5)), label = "temporaltrends", caption = "Average measures of community structure for the three survey periods (in each period all sites are surveyed once). The temporal trends and p-values are based on linear mixed models with normal distribution (except for alpha-diversity with Poisson distribution) with site-ID as random effect. Temporal-trends are given per 10 years. Linear mixed models could not be applied for beta- and gamma-diversity because measures are not available for the single sites."), include.rownames=FALSE)
```

The different measures of total community structure suggested that plant communities in mountain hay meadows were stable between 2003 and 2017 (Table \@ref(temporaltrends)): for each of the three 5-year survey periods the averages of alpha-, beta- and gamma-diversity, average Ellenberg values for temperature, nutrients, light and huminity, and average of species' canopy height, specific leaf area and seed mass did not vary much among the three sampling periods. For all measures, all p-values of the average temperal trends per site were $>0.05$ and only in the case of the average temperature value of the species the p-value was $<0.1$. Note that beta- and gamma-diversity are note available for single sites and thus mixed models to calculate the p-value could not be applied.

```{r modturnover}
tt <- rbind(
  sites %>% transmute(
    change = change1, 
    nochange = nochange1,
    period = 1),
  sites %>% transmute(
    change = change2, 
    nochange = nochange2,
    period = 2))
mod <- glm(cbind(change, nochange) ~ period, data = tt, family = binomial)
```

The temporal stability as inferred from the community measures were, however, in contrast to the large  observed temporal turnover of recorded species. The average percentage $\pm$ SD of species that differed between the first and second survey at a site was `r mean(100 * sites$change1 / (sites$nochange1 + sites$change1))` $\pm$ `r sd(100 * sites$change1 / (sites$nochange1 + sites$change1))`% and the percentage of species that differ between the second and third survey was `r mean(100 * sites$change2 / (sites$nochange2 + sites$change2))` $\pm$ `r sd(100 * sites$change2 / (sites$nochange2 + sites$change2))`%. There is some evidence that this slight decrease in the temporal turnover from the first and second survey to the temporal turnover of the second and third survey is systematic and was not entirly caused by change (Binomial generalized linear model; effect size = `r coef(mod)[2]`; p = `r summary(mod)$coefficients["period", "Pr(>|z|)"]`).

```{r compofvarianceran}
modcol <- summary(glmer(Occ ~ 1 + (1|aID_STAO) + (1|aID_SP), data = coldat, family = binomial))
modls <- summary(glmer(Occ ~ 1 + (1|aID_STAO) + (1|aID_SP), data = survdat, family = binomial))
getratio <- function(x) x[1] / x[2]
```

```{r compofvariance}
# Local survival
ref <- glmer(Occ ~ 1 + (1|aID_SP) + (1|aID_STAO), data = survdat, family = binomial)
modT <- glmer(Occ ~ Temperature * T + (1|aID_SP) + (1|aID_STAO), 
              data = survdat, family = binomial)
modF <- glmer(Occ ~ Precipitation * F + (1|aID_SP) + (1|aID_STAO), 
              data = survdat, family = binomial)
modN <- glmer(Occ ~ NTOT * N + (1|aID_SP) + (1|aID_STAO), 
              data = survdat, family = binomial)
modL <- glmer(Occ ~ Inclination * L + (1|aID_SP) + (1|aID_STAO), 
              data = survdat, family = binomial)
tt <- data.frame(anova(ref, modT, modF, modN, modL))
tt$Model <- c("Random change", "Temperature driven", "Precipitation driven", "Nitrogen driven", "Land-use driven")
tt <- tt[order(tt$AIC),]
tt$'Delta-AIC' <- tt$AIC - tt$AIC[1]
resls <- tt[, c("Model", "Df", "AIC", "Delta-AIC")]

# Colonization probability
ref <- glmer(Occ ~ 1 + (1|aID_SP) + (1|aID_STAO), data = coldat, family = binomial)
modT <- glmer(Occ ~ Temperature * T + (1|aID_SP) + (1|aID_STAO), 
              data = coldat, family = binomial)
modF <- glmer(Occ ~ Precipitation * F + (1|aID_SP) + (1|aID_STAO), 
              data = coldat, family = binomial)
modN <- glmer(Occ ~ NTOT * N + (1|aID_SP) + (1|aID_STAO), 
              data = coldat, family = binomial)
modL <- glmer(Occ ~ Inclination * L + (1|aID_SP) + (1|aID_STAO), 
              data = coldat, family = binomial)
tt <- data.frame(anova(ref, modT, modF, modN, modL))
tt$Model <- c("Random change", "Temperature driven", "Precipitation driven", "Nitrogen driven", "Land-use driven")
tt <- tt[order(tt$AIC),]
tt$'Delta-AIC' <- tt$AIC - tt$AIC[1]
rescol <- tt[, c("Model", "Df", "AIC", "Delta-AIC")]
```

```{r resdifeffects}
tt <- rbind(rescol, resls)
kable(tt, digits = 2, row.names = FALSE, format = "latex", caption = "Comparision of results from different drivers to explain colonization probability (a) and local survvival (b). See methods for the tested models.", booktabs = T) %>%
    kable_styling() %>%
    group_rows("(a) Colonization probability", 1, 5, bold = F, italic = T) %>%
    group_rows("(b) Local survival probability", 6, 10, bold = F, italic = T)
```

 Spatial turnover will be high if the probability a site is colonized by a species is high (i.e. high colonization probability) and/or if the probability that species survives at a site between two time points is low (i.e. low local survival). We found that the variation in local survival and colonization probability was largely due to differences between species and only to a lesser extend to the differences between locations: while the variance of the species random effect in a binomial linear mixed model for local survival was about `r getratio(unlist(modls$varcor))` times larger than the variance of the sampling site random effect, in the model for colonization the variance among species was even `r getratio(unlist(modcol$varcor))` times bigger than the variance among sites. 
 
 We inferred if we could explain differences in colonization and local survival with Ellenberg species values for temperature, humidity, nutrient or light (Table \@ref(tab:resdifeffects)). We found that both colonization probability and local survival probability was best explained by a model containing an interaction between species temperature and the average annual temperature of a site:  highest colonization probability and local survival were found  for the species with an Ellenberg value for Temperature that corresponded to the annual average temperature of the site (Fig. \@ref(fig:Teff)).. While the colonization and local survival probability of cold living species (Ellenberg T = 2) declindes along the temperature gradient, the colonization and local survival probability of warm living species (Ellenberg T = 4) increases along the temperature gradient (Fig. \@ref(fig:Teff)).
 
The second best model contained an interaction between species Ellenberg value for nutrient availability and the average annual N deposition rate of a site (Table \@ref(tab:resdifeffects)): the highest colonization probability and local survival were performed by species with an Ellenberg value for nutrient availability that corresponded to the annual N deposition rate of the site. While the colonization and local survival probability of oligotrophic species (Ellenberg N = 2) declindes along the N deposition gradient, the colonization and local survival probability of eutrophic species (N = 4) increases along the N deposition gradient (Fig. \@ref(fig:Neff)).

```{r Teff, fig.cap="Colonization (a) and local survival (b) of low temperature species (Ellenberg T = 2; red line) and high temperature species (Ellengerg T = 4) species along the temperature gradient. Given are means and 95\\%-Credible Intervals from logistic linear mixed models."}
X <- seq(0, 10, 0.2)
Xsd <- (X - 5) 

# Colonization
mod <- glmer(Occ ~ Temperature * T + (1|aID_SP) + (1|aID_STAO), data = coldat, family = binomial)
simdat <- arm::sim(mod, nsim)@fixef
post <- map(1:nsim, getposterior)
res <- rbind(compileres("EL = 2"), compileres("EL = 4"))
p1 <- ggplot(res, aes(x = X, y = mean, colour = value, shape = value)) +
  geom_ribbon(aes(ymin = low, ymax = high), fill = "black", col = "white", alpha = 0.2) +
  geom_line() +
    labs(title = "(a) Colonization", 
         y = "Colonization probability", 
         x = "Temperature gradient")

# Local survival
mod <- glmer(Occ ~ Temperature * T + (1|aID_SP) + (1|aID_STAO), data = survdat, family = binomial)
simdat <- arm::sim(mod, nsim)@fixef
post <- map(1:nsim, getposterior)
res <- rbind(compileres("EL = 2"), compileres("EL = 4"))
p2 <- ggplot(res, aes(x = X, y = mean, colour = value, shape = value)) +
  geom_ribbon(aes(ymin = low, ymax = high), fill = "black", col = "white", alpha = 0.2) +
  geom_line() +
    labs(title = "(b) Local survival", 
         y = "Local survival probability", 
         x = "Temperature gradient")
multiplot(p1, p2, cols = 2)
```

```{r Neff, fig.cap="Colonization (a) and local survival (b) of oligotrophic (Ellenberg N = 2; red line) and eutrophic (Ellengerg N = 4) species along the N deposition gradient. Given are means and 95\\%-Credible Intervals from logistic linear mixed models."}
X <- 0:50
Xsd <- (X - 10) / 10

# Colonization
mod <- glmer(Occ ~ NTOT * N + (1|aID_SP) + (1|aID_STAO), data = coldat, family = binomial)
simdat <- arm::sim(mod, nsim)@fixef
post <- map(1:nsim, getposterior)
res <- rbind(compileres("EL = 2"), compileres("EL = 4"))
p1 <- ggplot(res, aes(x = X, y = mean, colour = value, shape = value)) +
  geom_ribbon(aes(ymin = low, ymax = high), fill = "black", col = "white", alpha = 0.2) +
  geom_line() +
    labs(title = "(a) Colonization", 
         y = "Colonization probability", 
         x = "Nitrogen deposition")

# Local survival
mod <- glmer(Occ ~ NTOT * N + (1|aID_SP) + (1|aID_STAO), data = survdat, family = binomial)
simdat <- arm::sim(mod, nsim)@fixef
post <- map(1:nsim, getposterior)
res <- rbind(compileres("EL = 2"), compileres("EL = 4"))
p2 <- ggplot(res, aes(x = X, y = mean, colour = value, shape = value)) +
  geom_ribbon(aes(ymin = low, ymax = high), fill = "black", col = "white", alpha = 0.2) +
  geom_line() +
    labs(title = "(b) Local survival", 
         y = "Local survival probability", 
         x = "Nitrogen deposition")
multiplot(p1, p2, cols = 2)
```

```{r periodeffect}
# Temperature driven model
modTcol <- glmer(Occ ~ factor(Period) * Temperature * T + (1|aID_SP) + (1|aID_STAO),
               data = coldat, family = binomial)
modTls <- glmer(Occ ~ factor(Period) * Temperature * T + (1|aID_SP) + (1|aID_STAO),
               data = survdat, family = binomial)

# Nitrogen driven model
modNcol <- glmer(Occ ~ factor(Period) * NTOT * N + (1|aID_SP) + (1|aID_STAO),
               data = coldat, family = binomial)
modNls <- glmer(Occ ~ factor(Period) * NTOT * N + (1|aID_SP) + (1|aID_STAO),
               data = survdat, family = binomial)
```

For the temperature driven and nitrogen driven models in Table \@ref(tab:resdifeffects) we additionally tested whether the strength of the effects on colonization probability and local survival differed from the first/second to the second/third survey period. For the temperatur driven models we found that the differences how species with different Ellenberg T values responded to the average annual temperature of a site tended to decrease from the first/second study period to the second/third study period (colonization probability: period x Ellenberg T x annual mean temperature of site = `r fixef(modTcol)["factor(Period)2:Temperature:T"]`, p = `r summary(modTcol)$coefficients["factor(Period)2:Temperature:T", "Pr(>|z|)"]`; local survival: period x Ellenberg T x annual mean temperature of site = `r fixef(modTls)["factor(Period)2:Temperature:T"]`, p = `r summary(modTls)$coefficients["factor(Period)2:Temperature:T", "Pr(>|z|)"]`). In contrast, however, the differences how species with different Ellenberg N values responded to the average N deposition of a site tended to increase from the first/second study period to the second/third study period (colonization probability: period x Ellenberg N x N deposition at site = `r fixef(modNcol)["factor(Period)2:NTOT:N"]`, p = `r summary(modNcol)$coefficients["factor(Period)2:NTOT:N", "Pr(>|z|)"]`; local survival: period x Ellenberg N x N deposition at site = `r fixef(modNls)["factor(Period)2:NTOT:N"]`, p = `r summary(modNls)$coefficients["factor(Period)2:NTOT:N", "Pr(>|z|)"]`). 

```{r figconsequences, fig.cap="Beschreibung einfügen."}
# Change of correlation across study period
getcor <- function(year) {
  list(
    corT = cor(surv %>% filter(yearP >= year & yearP <= (year + 4)) %>% dplyr::select(Temperature, T))[1,2],
    corN = cor(surv %>% filter(yearP >= year & yearP <= (year + 4)) %>% dplyr::select(NTOT, N))[1,2])
}
tt <- map(2003:2013, getcor)
res <- rbind(
  tibble(cor = map_dbl(tt, "corN") / tt[[1]]$corN,
              driver = "NTOT",
              year = 2003:2013),
  tibble(cor = map_dbl(tt, "corT") / tt[[1]]$corT,
              driver = "Temperature",
              year = 2003:2013))




tt <- rbind(surv %>% transmute(CI = T, yr = yearPl - 2010, Type = "T", aID_STAO = aID_STAO),
            surv %>% transmute(CI = N, yr = yearPl - 2010, Type = "N", aID_STAO = aID_STAO))
m1 <- lmer(CI ~ Type * yr + (yr|aID_STAO), data = tt)
m2 <- lmer(CI ~ Type + yr + (yr|aID_STAO), data = tt)
anova(m1, m2)

m3 <- lmer(CI ~ Type + yr + (yr|aID_STAO), data = tt)

p1 <- ggplot(res, aes(x = year, y = cor, col = driver)) +
  geom_point() +
  geom_line() +
  ylim(0.95, 1.05)
res$yr <- res$year - 2010 
cormod <- lm(cor ~ yr * driver, data = res)

# Effect on N deposition model
surv$yr <- surv$yearPl - 2010
summary(glmer(SR ~ yr * NTOT * Temperature + (1|aID_STAO), data = surv, family = poisson))


makemod <- function(year) {
  mod <- glm(SR ~ Temperature + Precipitation + NTOT + Inclination, family = poisson,
      data = surv %>% filter(yearP >= year & yearP <= (year + 4)))
  arm::sim(mod, nsim)@coef
}
getestim <- function(x) {
  list(meanN = mean(x[, "NTOT"]),
       lowN = quantile(x[, "NTOT"], probs = 0.025),
       upN = quantile(x[, "NTOT"], probs = 0.975),
       meanT = mean(x[, "Temperature"]),
       lowT = quantile(x[, "Temperature"], probs = 0.25),
       upT = quantile(x[, "Temperature"], probs = 0.75))
}
tt <- map(2003:2013, makemod) %>% map(getestim)
res <- rbind(
  tibble(mean = map_dbl(tt, "meanN"),
              low = map_dbl(tt, "lowN"),
              up = map_dbl(tt, "upN"),
              factor = "NTOT",
              period = 2003:2013),
    tibble(mean = map_dbl(tt, "meanT"),
              low = map_dbl(tt, "lowT"),
              up = map_dbl(tt, "upT"),
              factor = "Temperature",
              period = 2003:2013))
pd <- position_dodge(0.5)
p2 <- ggplot(res, aes(x = period, y = mean, col = factor)) +
  geom_errorbar(aes(ymin = low, ymax = up), width = 0.5, position=pd) +
  geom_point(position=pd) +
  geom_line(position=pd) +
  geom_abline(intercept = 0, slope = 0) +
  ylim(-0.2, 0.05)
multiplot(p1, p2, cols = 2)
 # summary(lm(mean ~ factor * period, data = res))
```

It thus seems that temperature is the main driver of species turnover in the first part of the study period and its importance is slightly decreasing over time and nitrogen deposition becomes relatively more important as a driver that shapes the species communities. We thus expect to see that the correlation of the mean temperature value of a community with the yearly annual temperature of the site (temperature correlation) is decreasing over the years while the correlation of the mean nutrient value of a community with the N deposition of the site (nitrogen correlation) is increasing over the years. Our results tent to be in line with this expectation (linear model: temporal trend of temperature correlation x temporal trend of nitrogen correlation = `r coef(cormod)["yr:driverTemperature"]`, p = `r  summary(cormod)$coefficients["yr:driverTemperature", "Pr(>|t|)"]`), however the change in the correlation over the study period remained week and the temperature correlation remained stronger than the nitrogen correlation over the entire study period (Left panel of Fig. \@ref(fig:figconsequences)). More important, however, was the effect on our model that we used to infer whether and how strong the spatial variation in N deposition is correlated with Nitrogen deposition. If we apply that model the estimated effect of N depositon on total species richness is increasing over the study period (right panel of \@ref(fig:figconsequences)). 




```{r}
# Calculate trend for all species
gettrend <- function(s) {
  tt <- surv %>% left_join(pl %>% filter(aID_SP == s) %>% dplyr::select(aID_KD, Occ)) %>% 
    replace_na(list(Occ = 0))
  trend <- NA
  try(trend <- glmer(Occ ~ yr + (1|aID_STAO), data = tt, family = binomial) %>% 
    tidy() %>% 
    filter(term == "yr") %>% 
    pull(estimate))
trend
}
res <- pl %>% group_by(aID_SP, T, F, N, L) %>% 
  summarise(Nsites = n_distinct(aID_STAO),
            Nrecords = n())
res$Trend <- map_dbl(res$aID_SP, gettrend)
  
# Is trend of species related to Ellenberg values
gls(Trend ~ N, data = res) %>% 
  tidy


library("nlme")
vf <- varExp(form=~Nrecords)
gls(Trend ~ T, data = res %>% filter(!is.na(T)), weights=vf) %>% summary
gls(Trend ~ F, data = res %>% filter(!is.na(F)), weights=vf) %>% summary
gls(Trend ~ N, data = res %>% filter(!is.na(N)), weights=vf) %>% summary
gls(Trend ~ L, data = res %>% filter(!is.na(L)), weights=vf) %>% summary

cor.test(res$T, res$N)
```



```{r}
# Borrowoing ideas from community assembly
library(geometry)

getFric <- function(x) {
  tt <- pl %>% 
  filter(!is.na(T) & !is.na(F) & !is.na(N) & !is.na(L)) %>% 
  filter(aID_KD == x) %>% dplyr::select(T, F, N, L) 
  geometry::convhulln(tt, "FA")$vol
}

surv$FRic <- map_dbl(surv$aID_KD, getFric)

summary(lmer(FRic ~ yr + (yr|aID_STAO), data = surv))
tapply(surv$FRic, surv$Visit, mean)

ex1 <- dbFD(dummy$trait, dummy$abun)
ex1
```

--> Es gibt keine Einheitlichen Entwicklungen der Communities. Das heisst aber nicht, dass es keine systematischen Veränderungen gibt!



```{r}
# Functions 
getsamples <- function(s, nspec, d, EL) {
  sample(d %>% pull(paste(EL)), nspec, replace = FALSE) %>% mean(na.rm = TRUE)
}

getsim <- function(x, EL, gain) {
  tt <- pl %>% filter(aID_STAO == x) %>% 
    group_by(aID_SP, T, F, N, L) %>% 
    summarise(Occ1 = sum(Visit == 1),
              Occ2 = sum(Visit == 2),
              Occ3 = sum(Visit == 3))
  if(gain)  ausw <- (tt$Occ1 == 0 & tt$Occ2 == 1) | (tt$Occ2 == 0 & tt$Occ3 == 1)
  if(!gain) ausw <- (tt$Occ1 == 1 & tt$Occ2 == 0) | (tt$Occ2 == 1 & tt$Occ3 == 0)
  tmp <- map_dbl(1:nsim, getsamples, nspec = sum(ausw), d = tt, EL = EL)
  list(
    nchange = sum(ausw),
    meanreal = mean(tt[ausw, paste(EL)] %>% unlist, na.rm = TRUE),
    mean = mean(tmp, na.rm = TRUE),
    lower = quantile(tmp, probs = 0.025, na.rm = TRUE),
    upper = quantile(tmp, probs = 0.975, na.rm = TRUE))
}


res <- sites %>% 
  filter(NTOT < 4) %>% 
  transmute(aID_STAO = aID_STAO, Sitemeasure = NTOT)
tmp <- map(res$aID_STAO, getsim, EL = "N", gain = TRUE)
res$meanreal <- tmp %>% map_dbl("meanreal")
res$mean <- tmp %>% map_dbl("mean")
res$lower <- tmp %>% map_dbl("lower")
res$upper <- tmp %>% map_dbl("upper")
ggplot(res, aes(x = Sitemeasure, y = meanreal)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), lwd = 0.5, colour = "grey") +
  geom_point(shape = 4, colour = "black", cex = 2) +
  stat_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE, col = "black", alpha = 0.4) +
  stat_smooth(aes(y = mean), method = "lm", formula = y ~ poly(x,3), se = FALSE, col = "grey", alpha = 0.4) 

res1 <- rbind(
  res %>% transmute(aID_STAO = aID_STAO, Sitemeasure = Sitemeasure, mean = mean, type = "Sample"),
  res %>% transmute(aID_STAO = aID_STAO, Sitemeasure = Sitemeasure, mean = meanreal, type = "Real"))
mod1 <- lmer(mean ~ Sitemeasure * type + (1|aID_STAO), data = res1)
mod2 <- lmer(mean ~ Sitemeasure + type + (1|aID_STAO), data = res1)
anova(mod1, mod2)


summary(glmer(SR ~ yr * NTOT + (yr|aID_STAO), data = surv, family = "poisson"))
mod1 <- lmer(N ~ yr * NTOT + (yr|aID_STAO), data = surv)
mod2 <- lmer(N ~ yr + NTOT + (yr|aID_STAO), data = surv)
anova(mod1, mod2)


t.test(sites$ngain)
t.test(sites$nlost)

lm(ngain ~ Inclination + Temperature + Precipitation  + NTOT, data = sites) %>% 
  tidy
  
plot(sites$ngain, sites$nlost)


tapply()

```




# Discussion {-}
- Any empty space that could be caused by any disturbance that let to the local disappearance of species is likely to be fiellied by eutrophic species. Disturbance depends on the site, while colonization depends on species characteristics.

- The rather large spatial turnover might be partly explained by species that remained undetected in one of the surveys, but it might also be the result of species that newly colonized sites (species gains) and species that truely disappeared from sites (species losses).

- Altough N deposition considerabely declinded between 2005 and 2015, we could not detect major shifts in plant community structure during the same time period. 

- Eutrophic species have rather high local survival across the entire deposition gradient, while oligotrophic species have much reduced local survival at high N deposition. This suggests that it takes much more time to replace eutrophic by oligotrophic species than replacing oligotrophic by eutrophic species. 

- Our data on colonization and local survival (i.e. temporal variation) confirm the empirical critical loads that we infered from anlysing spatial co-variation of N deposition and species richness.  

- Local survival is higher for low temperature plants --> This could explain the decrease in cumminity change along elevation. This could also explain the differences at mount summets were space was empty in the beginning.

- Climatic effects are more likely to be reversed thant effects due to fertilization.


### Space for time substitution
Often observational studies infer the change of plant diversity along a gradient of N deposi- tion. Thus, they infer how the spatial variation in species richness is related to N deposition and assume that this spatial variation in species richness arose because over time some areas lost more species than others because they chronically experienced higher N deposition. Alt- hough there is evidence supporting the use of such a 'space for time substitution' for detecting the effects of N deposition on plant diversity (Stevens et al. 2010), they can not replace stud- ies that relate temporal patterns in species with N deposition (De Schrijver et al. 2011). While recovery of acidified surface waters has been well investigated (De Vries et al. 2015), there are only a limited number of studies inferring temporal trends of plant species diversity relat- ed to varying amounts of N-deposition. Storkey et al. (2015) demonstrated a positive response of biodiversity to reducing N addition from either atmospheric pollution or fertilizers in the Park Grass Experiment: «The proportion of legumes, species richness and diversity increased across the experiment between 1991 and 2012 as N-deposition declined». For forest floor vegetation in permanent plots across Europe the exceedance of critical loads of N over a peri- od from 9 to 42 years had negative effects on the cover of oligotrophic plant species, i.e spe- cies that prefer nutrient-poor soils, although species richness remained constant (Dirnböck et al. 2014). Another example of recovery in eutrophicated habitats gives the recovery of species richness in previously fertilized plots (Clark and Tilman 2008). In this study, the recorded recovery in species richness within one or two decade was likely due to the species rich vege- tation surrounding the experimental plots, from where immigration was easily feasible.

> Hier sagen, dass der CRL identisch wie der CRL von räumlichen Zusammenhängen ist.




# Conclusions {-}
xxx

# Acknowledgements {-}
We thank the dedicated and qualified botanists who conducted fieldwork. The Swiss Federal Office for the Environment (FOEN) kindly provided biodiversity monitoring data and topographic data. This work was supported by the FOEN, the Swiss National Science Foundation (grant no. 31003A_156294), the Swiss Association Pro Petite Camargue Alsacienne, the Fondation de bienfaisance Jeanne Lovioz, and the MAVA Foundation.

# References {-}




```{r}
# The MS was build with the following R sesstion:
writeLines(capture.output(sessionInfo()), "sessionInfo.txt")
```

